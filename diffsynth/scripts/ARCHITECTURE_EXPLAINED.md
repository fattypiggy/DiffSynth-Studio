# Delit æ¨¡å‹æ¶æ„è¯¦è§£

## ğŸ¯ ä»»åŠ¡ç›®æ ‡

**è¾“å…¥**: Relit å›¾åƒï¼ˆäººç‰© + ç¯å¢ƒå…‰ç…§ï¼‰
**è¾“å‡º**:
- Flat-lit å›¾åƒï¼ˆå»é™¤å…‰ç…§çš„äººç‰©ï¼‰
- Environment Mapï¼ˆHDR ç¯å¢ƒå…‰ç…§å›¾ï¼‰

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ–¹æ¡ˆï¼šä½¿ç”¨ Wan Video VAE + æ–°å¢ç½‘ç»œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Relit Image                          â”‚
â”‚                   [B, 3, 512, 512]                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Wan Video VAE Encoder                      â”‚
â”‚                   (FROZEN â„ï¸)                           â”‚
â”‚   åŠ è½½è‡ª: Wan2.2-I2V-A14B/vae.pth                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼ Latent [B, 16, 64, 64]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Feature Extractor                          â”‚
â”‚                (TRAINABLE ğŸ”¥)                           â”‚
â”‚   Conv layers: 16 -> 32 channels                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼ [B, 32, 64, 64]
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                       â”‚
         â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Flat Proj      â”‚    â”‚   Env Proj      â”‚
â”‚ (TRAINABLE ğŸ”¥)  â”‚    â”‚ (TRAINABLE ğŸ”¥)  â”‚
â”‚  32 -> 16 ch    â”‚    â”‚  32 -> 16 ch    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â–¼                       â–¼
    [B,16,64,64]           [B,16,64,64]
         â”‚                       â”‚
         â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Wan VAE Dec    â”‚    â”‚  Env Decoder    â”‚
â”‚  (FROZEN â„ï¸)    â”‚    â”‚ (TRAINABLE ğŸ”¥)  â”‚
â”‚                 â”‚    â”‚ 16->128->256 ch â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â–¼                       â–¼
    Flat-lit               Env Map
  [B,3,512,512]         [B,4,128,256]
```

## ğŸ“ å…³é”®æ¦‚å¿µæ¾„æ¸…

### âŒ è¯¯è§£ 1: "è®­ç»ƒ DiT"
**å®é™…æƒ…å†µ**:
- æˆ‘ä»¬**ä¸è®­ç»ƒ** Wan2.2 çš„ DiTï¼ˆæ‰©æ•£æ¨¡å‹ï¼‰
- æˆ‘ä»¬åª**ä½¿ç”¨** Wan Video VAE çš„ encoder å’Œ decoder
- Wan2.2 çš„ DiT å®Œå…¨ä¸ä¼šè¢«ä½¿ç”¨

### âŒ è¯¯è§£ 2: "å¿…é¡»ç”¨ LoRA"
**å®é™…æƒ…å†µ**:
- **æ–¹æ¡ˆ A**ï¼ˆæ¨èï¼‰: å†»ç»“ VAEï¼Œè®­ç»ƒæ–°å¢ç½‘ç»œ
  - è®­ç»ƒå‚æ•°: ~5-10Mï¼ˆFeature Extractor + æŠ•å½±å±‚ + Env Decoderï¼‰
  - ä¼˜ç‚¹: ç®€å•ï¼Œå¿«é€Ÿï¼Œç¨³å®š

- **æ–¹æ¡ˆ B**ï¼ˆå¯é€‰ï¼‰: å†»ç»“ VAE + LoRA å¾®è°ƒéƒ¨åˆ†å±‚
  - å¯ä»¥å¯¹ VAE decoder æ·»åŠ  LoRA é€‚é…å™¨
  - è®­ç»ƒå‚æ•°: ~5-10M + LoRA å‚æ•°
  - ä¼˜ç‚¹: å¯èƒ½è·å¾—æ›´å¥½çš„ flat-lit è´¨é‡
  - ç¼ºç‚¹: æ›´å¤æ‚ï¼Œéœ€è¦æ›´å¤šè°ƒè¯•

**æˆ‘çš„å®ç°ä½¿ç”¨æ–¹æ¡ˆ A**ï¼Œå› ä¸ºæ›´ç®€å•ç›´æ¥ã€‚

### âœ… æ­£ç¡®ç†è§£: "æ–°å¢ä¸¤ä¸ªåˆ†æ”¯"
**å®Œå…¨æ­£ç¡®**ï¼

åˆ†æ”¯ 1: **Flat-lit åˆ†æ”¯**
- Feature Extractor -> Flat Projection -> VAE Decoder (frozen)
- è¾“å‡º: [B, 3, 512, 512] å»å…‰ç…§å›¾åƒ

åˆ†æ”¯ 2: **Env Map åˆ†æ”¯**
- Feature Extractor -> Env Projection -> Env Decoder (trainable)
- è¾“å‡º: [B, 4, 128, 256] ç¼–ç çš„ç¯å¢ƒå›¾

## ğŸ” Wan2.2-I2V-A14B è¯¦è§£

### æ–‡ä»¶ç»“æ„ï¼ˆé¢„æœŸï¼‰
```
Wan2.2-I2V-A14B/
â”œâ”€â”€ vae.pth              # âœ… æˆ‘ä»¬éœ€è¦è¿™ä¸ª
â”œâ”€â”€ dit.pth              # âŒ ä¸éœ€è¦
â””â”€â”€ text_encoder.pth     # âŒ ä¸éœ€è¦
```

### I2V æ˜¯å¦é€‚åˆï¼Ÿ
**âœ… å®Œå…¨é€‚åˆï¼**

- **I2V** = Image to Videoï¼ˆå›¾åƒç”Ÿæˆè§†é¢‘ï¼‰
- åŒ…å«çš„ **Video VAE** å®Œå…¨å¯ä»¥ç”¨äºå•å¸§å›¾åƒ
- VAE æ¶æ„é€šå¸¸æ˜¯ï¼š
  - Encoder: [B, 3, T, H, W] -> [B, 16, T/4, H/8, W/8]
  - Decoder: [B, 16, T/4, H/8, W/8] -> [B, 3, T, H, W]

- å¯¹äºå•å¸§ï¼ˆT=1ï¼‰ï¼š
  - Encoder: [B, 3, 1, 512, 512] -> [B, 16, 1, 64, 64]
  - Decoder: [B, 16, 1, 64, 64] -> [B, 3, 1, 512, 512]

**å®Œå…¨æ²¡é—®é¢˜ï¼**

## ğŸ¤” DiffSynth-Studio å¦‚ä½•è®­ç»ƒ Wan2.2ï¼Ÿ

### ç­”æ¡ˆï¼šDiffSynth-Studio ä¸è®­ç»ƒ Wan2.2

**DiffSynth-Studio çš„å®šä½**ï¼š
- âœ… **æ¨ç†æ¡†æ¶**ï¼šæä¾›å„ç§æ¨¡å‹çš„æ¨ç†æ¥å£
- âœ… **è®­ç»ƒå·¥å…·**ï¼šæä¾›é€šç”¨çš„è®­ç»ƒæ¨¡å—ï¼ˆå¦‚ LoRAï¼‰
- âŒ **ä¸æä¾›å®Œæ•´è®­ç»ƒ**ï¼šä¸åŒ…å«ä»å¤´è®­ç»ƒ Wan2.2 çš„ä»£ç 

**Wan2.2 çš„è®­ç»ƒ**ï¼š
- ç”± Wan2.2 å›¢é˜Ÿå®Œæˆ
- ä½¿ç”¨å¤§è§„æ¨¡è§†é¢‘æ•°æ®
- è®­ç»ƒä»£ç **å¯èƒ½æœªå¼€æº**

**æˆ‘ä»¬çš„ä»»åŠ¡**ï¼š
- ä½¿ç”¨**é¢„è®­ç»ƒçš„ Wan VAE**
- åªè®­ç»ƒ**æ–°å¢çš„ delit ç½‘ç»œ**
- ä¸éœ€è¦ Wan2.2 çš„è®­ç»ƒä»£ç 

## ğŸ“Š å‚æ•°ç»Ÿè®¡

### æ€»å‚æ•°
- **Wan VAE**: ~40Mï¼ˆfrozen â„ï¸ï¼‰
- **Feature Extractor**: ~2Mï¼ˆtrainable ğŸ”¥ï¼‰
- **Flat Projection**: ~0.5Mï¼ˆtrainable ğŸ”¥ï¼‰
- **Env Projection**: ~0.5Mï¼ˆtrainable ğŸ”¥ï¼‰
- **Env Decoder**: ~2Mï¼ˆtrainable ğŸ”¥ï¼‰

### è®­ç»ƒå‚æ•°
- **æ€»è®¡**: ~5Mï¼ˆåªå æ€»å‚æ•°çš„ 10%ï¼‰
- **GPU å†…å­˜**: é¢„è®¡ 12-16GBï¼ˆbatch_size=4ï¼‰

## ğŸ¯ ä¸ LoRA æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆ A: çº¯å†»ç»“ VAEï¼ˆå½“å‰å®ç°ï¼‰
```python
model = DelitDiT(
    vae=vae,
    freeze_vae=True  # VAE å®Œå…¨å†»ç»“
)
```
**è®­ç»ƒ**: Feature Extractor + ä¸¤ä¸ªæŠ•å½± + Env Decoder

### æ–¹æ¡ˆ B: VAE + LoRA å¾®è°ƒ
```python
# 1. å†»ç»“ VAE
for param in vae.parameters():
    param.requires_grad = False

# 2. åœ¨ VAE decoder æ·»åŠ  LoRA
from diffsynth.diffusion import DiffusionTrainingModule
training_module = DiffusionTrainingModule()
vae.model.decoder = training_module.add_lora_to_model(
    vae.model.decoder,
    target_modules=["Conv2d"],  # æˆ–å…¶ä»–å±‚
    lora_rank=16,
    lora_alpha=16
)

# 3. åˆ›å»º Delit æ¨¡å‹
model = DelitDiT(vae=vae, freeze_vae=False)
```
**è®­ç»ƒ**: Feature Extractor + ä¸¤ä¸ªæŠ•å½± + Env Decoder + **VAE LoRA**

**ä½•æ—¶ä½¿ç”¨æ–¹æ¡ˆ B**ï¼š
- âœ… Flat-lit é‡å»ºè´¨é‡ä¸å¤Ÿå¥½
- âœ… æœ‰è¶³å¤Ÿçš„è®­ç»ƒæ•°æ®
- âœ… æ„¿æ„èŠ±æ›´å¤šæ—¶é—´è°ƒè¯•

**æ¨è**ï¼šå…ˆç”¨æ–¹æ¡ˆ Aï¼Œå¦‚æœæ•ˆæœä¸å¥½å†è€ƒè™‘æ–¹æ¡ˆ B

## ğŸš€ å®é™…ä½¿ç”¨

### åŠ è½½ Wan2.2-I2V-A14B

```bash
# å‡è®¾ä½ çš„æƒé‡åœ¨è¿™é‡Œ
ls diffsynth/Wan2.2-I2V-A14B/
# åº”è¯¥çœ‹åˆ°: vae.pth æˆ–ç±»ä¼¼çš„æ–‡ä»¶

# åŠ è½½ VAE
python scripts/load_wan_vae.py \
  --checkpoint diffsynth/Wan2.2-I2V-A14B/vae.pth \
  --test
```

å¦‚æœ VAE ä¸æ˜¯å•ç‹¬çš„æ–‡ä»¶ï¼Œè€Œæ˜¯åŒ…å«åœ¨å®Œæ•´æ¨¡å‹ä¸­ï¼š
```python
# éœ€è¦ä¿®æ”¹ load_wan_vae.py æ¥å¤„ç†
# æˆ–è€…æ‰‹åŠ¨æå– VAE éƒ¨åˆ†
```

### è®­ç»ƒ Delit

```bash
python scripts/train_delit_wan.py \
  --wan_vae_checkpoint diffsynth/Wan2.2-I2V-A14B/vae.pth \
  --data_root /path/to/your/data \
  --output_dir ./output/delit_exp1 \
  --batch_size 4 \
  --num_epochs 100 \
  --freeze_vae  # å†»ç»“ VAEï¼ˆæ¨èï¼‰
```

## ğŸ“ æ€»ç»“

### ä½ çš„ä»»åŠ¡
1. âœ… å›ºå®š Wan Video VAE
2. âŒ **ä¸æ˜¯**è®­ç»ƒ Wan2.2 çš„ DiT
3. âœ… è®­ç»ƒä¸€ä¸ª**æ–°çš„ delit ç½‘ç»œ**
4. âœ… åŒ…å«ä¸¤ä¸ªåˆ†æ”¯
5. âš ï¸ LoRA æ˜¯**å¯é€‰çš„**ï¼Œä¸æ˜¯å¿…é¡»çš„

### å…³é”®ç‚¹
- **Wan2.2 I2V** å®Œå…¨é€‚åˆä½ çš„ä»»åŠ¡
- åªéœ€è¦ **VAE éƒ¨åˆ†**
- **ä¸éœ€è¦** Wan2.2 çš„è®­ç»ƒä»£ç 
- **ä¸è®­ç»ƒ** DiTï¼Œåªç”¨ VAE
- è®­ç»ƒå‚æ•°åªæœ‰ ~5Mï¼ˆå¾ˆå°ï¼‰

---

**ä¸‹ä¸€æ­¥**: æ£€æŸ¥ä½ çš„ `Wan2.2-I2V-A14B` ç›®å½•ï¼Œæ‰¾åˆ° VAE checkpoint æ–‡ä»¶ã€‚
